<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2025 Racing Schedules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Clarity Analytics -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "q5g6pdi6gf");
  </script>

  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link href="src/styles/main.css" rel="stylesheet">
</head>
<body>
  <div class="container my-4">
    <!-- Header with Theme Toggle -->
    <header class="site-header d-flex justify-content-between align-items-center">
      <h1 class="text-center">2025 Racing Schedules</h1>
      <button id="themeToggle" class="btn btn-secondary" aria-label="Toggle Dark Mode">
        <i class="fas" id="themeIcon"></i>
      </button>
    </header>

    <!-- Upcoming Event Section -->
    <div id="upcoming-event" class="upcoming-event">
      <div class="row">
        <div class="col-12">
          <h4 class="mb-3"><i class="fas fa-flag-checkered me-2"></i>Upcoming Races</h4>
          <div id="upcomingEventDetails" class="upcoming-events-list"></div>
        </div>
      </div>
    </div>

    <!-- Global Search -->
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="Search events...">
      <i class="fas fa-search search-icon"></i>
    </div>

    <!-- Schedule Tabs -->
    <ul class="nav nav-tabs" id="scheduleTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="true">
          All Series
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="f1-tab" data-bs-toggle="tab" data-bs-target="#f1" type="button" role="tab" aria-controls="f1" aria-selected="false">
          Formula 1
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="indy-tab" data-bs-toggle="tab" data-bs-target="#indy" type="button" role="tab" aria-controls="indy" aria-selected="false">
          IndyCar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="nascar-tab" data-bs-toggle="tab" data-bs-target="#nascar" type="button" role="tab" aria-controls="nascar" aria-selected="false">
          NASCAR Cup
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="scheduleTabsContent">
      <!-- All Series Tab -->
      <div class="tab-pane fade show active" id="all" role="tabpanel" aria-labelledby="all-tab">
        <div class="table-responsive">
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Date</th>
                <th>Series</th>
                <th>Race</th>
                <th>Venue</th>
                <th>Time/Network</th>
              </tr>
            </thead>
            <tbody id="all-table-body">
              <!-- All events will be injected here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Formula 1 Tab -->
      <div class="tab-pane fade" id="f1" role="tabpanel" aria-labelledby="f1-tab">
        <div class="table-responsive">
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Date</th>
                <th>Race</th>
                <th>Circuit</th>
                <th>Time (Local)</th>
              </tr>
            </thead>
            <tbody id="f1-table-body">
              <!-- F1 events will be injected here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- IndyCar Tab -->
      <div class="tab-pane fade" id="indy" role="tabpanel" aria-labelledby="indy-tab">
        <div class="table-responsive">
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Date</th>
                <th>Race</th>
                <th>Venue</th>
                <th>Network</th>
              </tr>
            </thead>
            <tbody id="indy-table-body">
              <!-- IndyCar events will be injected here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- NASCAR Cup Tab -->
      <div class="tab-pane fade" id="nascar" role="tabpanel" aria-labelledby="nascar-tab">
        <!-- NASCAR Regular Season -->
        <h3 class="mt-3">Regular Season</h3>
        <div class="table-responsive">
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Date</th>
                <th>Race</th>
                <th>Venue</th>
                <th>Network</th>
              </tr>
            </thead>
            <tbody id="nascar-regular-table-body">
              <!-- NASCAR Regular events will be injected here -->
            </tbody>
          </table>
        </div>
        <!-- NASCAR Playoffs -->
        <h3 class="mt-3">Playoffs</h3>
        <div class="table-responsive">
          <table class="table table-striped mt-3">
            <thead>
              <tr>
                <th>Date</th>
                <th>Race</th>
                <th>Venue</th>
                <th>Network</th>
              </tr>
            </thead>
            <tbody id="nascar-playoffs-table-body">
              <!-- NASCAR Playoff events will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- News Section -->
    <section class="mt-5">
      <h2>Latest News</h2>
      <div id="newsGrid" class="row g-4 mt-3"></div>
    </section>
  </div>

  <!-- Event Detail Modal (includes weather forecast functionality) -->
  <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Event Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="event-details">
            <div class="series-badge mb-3" id="modalEventSeries"></div>
            <h5 class="mb-3" id="modalEventRace"></h5>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Date:</strong> <span id="modalEventDate"></span></p>
                <p><strong>Location:</strong> <span id="modalEventLocation"></span></p>
                <p><strong>Time:</strong> <span id="modalEventTime"></span></p>
              </div>
              <div class="col-md-6">
                <div id="modalCountdown" class="countdown-timer mb-3"></div>
              </div>
            </div>
          </div>
          
          <!-- Weather Section -->
          <div id="weatherSection" class="mt-4">
            <button id="fetchWeatherBtn" class="btn btn-info btn-sm">
              Show Weather Forecast
            </button>
            <div id="weatherResult" class="mt-2"></div>
          </div>
          
          <!-- Social Share -->
          <div id="socialShare" class="mt-4">
            <h6>Share this event</h6>
            <div class="d-flex gap-2">
              <a href="#" id="shareTwitter" class="btn btn-sm btn-outline-primary">
                Share on X
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Application Script -->
  <script type="module">
    // Import your data from data.js
    import { scheduleData, resultsData, parseEventDate, enhanceEventData } from './src/js/data.js';

    /*******************************
     * Helper Functions
     *******************************/
    
    function clearCountdown(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = '';
        if (element.countdownInterval) {
          clearInterval(element.countdownInterval);
          element.countdownInterval = null;
        }
      }
    }
    
    function startCountdown(elementId, startTime) {
      clearCountdown(elementId);
      const countdownElement = document.getElementById(elementId);
      const updateCountdown = () => {
        const now = new Date().getTime();
        const distance = startTime - now;
        if (distance < 0) {
          clearCountdown(elementId);
          countdownElement.textContent = 'Event Started';
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      };
      updateCountdown();
      countdownElement.countdownInterval = setInterval(updateCountdown, 1000);
    }
    
    // Function to convert PT time to local timezone
    function convertToLocalTime(dateStr, timeStr) {
      if (!timeStr) return "";
      
      // Parse the date and time
      const [month, day] = dateStr.split(" ");
      const months = {
        "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5,
        "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11
      };
      
      // Parse time components
      const [time, period] = timeStr.split(" ");
      const [hours, minutes] = time.split(":");
      let hour = parseInt(hours);
      
      // Convert to 24-hour format
      if (period === "PM" && hour !== 12) hour += 12;
      if (period === "AM" && hour === 12) hour = 0;
      
      // Create date object in PT (2025 for the racing season)
      const date = new Date(Date.UTC(2025, months[month], parseInt(day)));
      
      // Determine if date is in DST for PT (second Sunday in March to first Sunday in November)
      const year = 2025;
      const dstStart = new Date(year, 2, 14 - new Date(year, 2, 14).getDay()); // Second Sunday in March
      const dstEnd = new Date(year, 10, 7 - new Date(year, 10, 1).getDay());   // First Sunday in November
      const isDST = date >= dstStart && date < dstEnd;
      
      // Set the time in PT, accounting for DST
      const ptOffset = isDST ? 7 : 8; // PT is UTC-7 during DST, UTC-8 during standard time
      date.setUTCHours(hour + ptOffset);
      date.setUTCMinutes(parseInt(minutes || 0));
      
      // The date object is now in UTC, converting to local automatically
      return date.toLocaleTimeString([], { 
        hour: 'numeric', 
        minute: '2-digit',
        timeZoneName: 'short'
      });
    }
    
    function populateTable(tableBodyId, events, columns) {
      const tbody = document.getElementById(tableBodyId);
      const now = new Date();
      
      events.forEach(event => {
        const tr = document.createElement("tr");
        const eventStartDate = parseEventDate(event.date);
        tr.setAttribute("data-start", eventStartDate.toISOString());
        
        // Check if the race is completed
        if (eventStartDate < now) {
          tr.classList.add("completed-race");
          
          // Find race results - handle multiple results for events like Duels
          let results = [];
          if (event.series === "Formula 1") {
            // For F1, remove "GP" and try to match the Grand Prix name
            const raceName = event.race.replace(" GP", "");
            const result = resultsData.f1Past.results.find(r => 
              r.grandPrix.toLowerCase().includes(raceName.toLowerCase()) ||
              raceName.toLowerCase().includes(r.grandPrix.toLowerCase())
            );
            if (result) results.push(result);
          } else if (event.series === "IndyCar") {
            // For IndyCar, try to match the full name or partial name
            const result = resultsData.indyPast.results.find(r => 
              r.race.toLowerCase().includes(event.race.toLowerCase()) ||
              event.race.toLowerCase().includes(r.race.toLowerCase())
            );
            if (result) results.push(result);
          } else if (event.series.includes("NASCAR")) {
            // For NASCAR, handle special cases like Duels
            if (event.race.includes("Duel")) {
              // Find all Duel results
              results = resultsData.nascarPast.results.filter(r => 
                r.race.toLowerCase().includes("duel")
              );
            } else {
              // For other NASCAR races, try to match by the main race name
              const eventShortName = event.race.split(" at ")[0].toLowerCase();
              const result = resultsData.nascarPast.results.find(r => 
                r.race.toLowerCase().includes(eventShortName) ||
                eventShortName.includes(r.race.toLowerCase())
              );
              if (result) results.push(result);
            }
          }
          
          // Create cells with podium information
          columns.forEach((col, index) => {
            const td = document.createElement("td");
            if (col === "time" && event.time) {
              // Convert time to local timezone
              td.textContent = convertToLocalTime(event.date, event.time);
            } else {
              td.textContent = event[col];
            }
            
            // Add podium information to the race name cell
            if (col === "race" && results.length > 0) {
              const podiumDiv = document.createElement("div");
              podiumDiv.className = "podium-results";
              
              // Create HTML for each result
              const podiumHTML = results.map(result => {
                let resultTitle = results.length > 1 ? `<strong>${result.race}:</strong><br>` : "";
                return `
                  ${resultTitle}
                  <span><span class="podium-position">1st:</span> ${result.winner}</span>
                  <span><span class="podium-position">2nd:</span> ${result.second}</span>
                  <span><span class="podium-position">3rd:</span> ${result.third}</span>
                `;
              }).join('<hr class="podium-divider">');
              
              podiumDiv.innerHTML = podiumHTML;
              td.appendChild(podiumDiv);
            }
            
            tr.appendChild(td);
          });
        } else {
          // Regular event without results
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = event[col];
            tr.appendChild(td);
          });
        }
        
        tr.addEventListener("click", () => openEventModal(event));
        tbody.appendChild(tr);
      });
    }
    
    function openEventModal(event) {
      const modal = new bootstrap.Modal(document.getElementById("eventDetailModal"));
      
      // Update modal content
      document.getElementById("modalEventSeries").textContent = event.series;
      document.getElementById("modalEventRace").textContent = event.race;
      document.getElementById("modalEventDate").textContent = event.date;
      document.getElementById("modalEventLocation").textContent = event.circuit || event.venue || "TBA";
      document.getElementById("modalEventTime").textContent = event.time || "TBA";
      
      // Start countdown
      startCountdown("modalCountdown", event.start.getTime());
      
      // Setup weather button
      document.getElementById("fetchWeatherBtn").onclick = () => {
        if (event.latitude && event.longitude) {
          fetchWeather(event.latitude, event.longitude);
        } else {
          document.getElementById("weatherResult").innerHTML = 
            "<div class='alert alert-warning'>Weather data not available for this location.</div>";
        }
      };
      
      // Update share link
      const shareText = `Check out the ${event.race} on ${event.date}! #Motorsports`;
      document.getElementById("shareTwitter").href = 
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
      
      modal.show();
    }
    
    async function fetchWeather(lat, lon) {
      const weatherDiv = document.getElementById("weatherResult");
      weatherDiv.innerHTML = "<p>Loading weather data...</p>";
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=76e88dcc2deedd45254cb828a080cb54`);
        const data = await response.json();
        if (response.ok) {
          const temp = Math.round(data.main.temp);
          const conditions = data.weather[0].description;
          weatherDiv.innerHTML = `
            <div class="weather-card">
              <p><strong>Temperature:</strong> ${temp}°C</p>
              <p><strong>Conditions:</strong> ${conditions}</p>
              <p><strong>Humidity:</strong> ${data.main.humidity}%</p>
            </div>
          `;
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        weatherDiv.innerHTML = "<p class='text-danger'>Unable to fetch weather data.</p>";
        console.error("Error fetching weather:", error);
      }
    }
    
    function displayUpcomingEvent() {
      const allEvents = enhanceEventData();
      allEvents.sort((a, b) => a.start - b.start);
      const now = new Date();

      // Get this weekend's date range (Friday to Sunday)
      const friday = new Date(now);
      friday.setDate(now.getDate() + ((5 - now.getDay() + 7) % 7));
      friday.setHours(0, 0, 0, 0);
      
      const sunday = new Date(friday);
      sunday.setDate(friday.getDate() + 2);
      sunday.setHours(23, 59, 59, 999);

      // Find all events this weekend
      const weekendEvents = allEvents.filter(event => 
        event.start >= friday && event.start <= sunday
      );

      // Find next event if no weekend events
      const nextEvent = allEvents.find(event => event.start >= now);

      const upcomingDiv = document.getElementById("upcomingEventDetails");
      
      if (weekendEvents.length > 0) {
        // Display all weekend events using Bootstrap card markup
        upcomingDiv.innerHTML = weekendEvents.map(event => {
          const location = event.circuit || event.venue || "TBA";
          const timeString = event.time ? `<p class="card-text mb-1"><strong>Time:</strong> ${event.time}</p>` : "";
          const countdownId = `countdown-${event.series.replace(/\s+/g, '-').toLowerCase()}`;
          
          // Start the countdown after insertion
          setTimeout(() => startCountdown(countdownId, event.start.getTime()), 0);
          
          return `
            <div class="card upcoming-event-item mb-3">
              <div class="card-body">
                <div class="series-badge mb-2">${event.series}</div>
                <h5 class="card-title mb-2">${event.race}</h5>
                <p class="card-text mb-1"><strong>Date:</strong> ${event.date}</p>
                <p class="card-text mb-1"><strong>Location:</strong> ${location}</p>
                ${timeString}
                <div id="${countdownId}" class="countdown-timer mt-2"></div>
              </div>
            </div>
          `;
        }).join('');
      } else if (nextEvent) {
        const location = nextEvent.circuit || nextEvent.venue || "TBA";
        const timeString = nextEvent.time ? `<p class="card-text mb-1"><strong>Time:</strong> ${nextEvent.time}</p>` : "";
        
        upcomingDiv.innerHTML = `
          <div class="card upcoming-event-item mb-3">
            <div class="card-body">
              <div class="series-badge mb-2">${nextEvent.series}</div>
              <h5 class="card-title mb-2">${nextEvent.race}</h5>
              <p class="card-text mb-1"><strong>Date:</strong> ${nextEvent.date}</p>
              <p class="card-text mb-1"><strong>Location:</strong> ${location}</p>
              ${timeString}
              <div id="eventCountdown" class="countdown-timer mt-2"></div>
            </div>
          </div>
        `;
        
        startCountdown("eventCountdown", nextEvent.start.getTime());
      } else {
        upcomingDiv.innerHTML = "<p>No upcoming events scheduled.</p>";
      }
    }
    
    async function fetchNews() {
      const f1Feed = "https://www.motorsport.com/rss/f1/news/";
      const indyFeed = "https://www.motorsport.com/rss/indycar/news/";
      const nascarFeed = "https://www.motorsport.com/rss/nascar-cup/news/";
      try {
        const [f1News, indyNews, nascarNews] = await Promise.all([
          fetchRSS(f1Feed),
          fetchRSS(indyFeed),
          fetchRSS(nascarFeed)
        ]);
    
        const newsGrid = document.getElementById("newsGrid");
        newsGrid.innerHTML = `
          <div class="col-md-4">
            <div class="card news-card h-100">
              <div class="card-body">
                <h5 class="card-title news-title">F1 News</h5>
                ${f1News.map(item => `
                  <div class="news-item mb-3">
                    <a href="${item.link}" target="_blank" class="news-link">${item.title}</a>
                    <p class="news-date"><small>${new Date(item.pubDate).toLocaleDateString()}</small></p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card news-card h-100">
              <div class="card-body">
                <h5 class="card-title news-title">IndyCar News</h5>
                ${indyNews.map(item => `
                  <div class="news-item mb-3">
                    <a href="${item.link}" target="_blank" class="news-link">${item.title}</a>
                    <p class="news-date"><small>${new Date(item.pubDate).toLocaleDateString()}</small></p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card news-card h-100">
              <div class="card-body">
                <h5 class="card-title news-title">NASCAR News</h5>
                ${nascarNews.map(item => `
                  <div class="news-item mb-3">
                    <a href="${item.link}" target="_blank" class="news-link">${item.title}</a>
                    <p class="news-date"><small>${new Date(item.pubDate).toLocaleDateString()}</small></p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        document.getElementById("newsGrid").innerHTML = "<p class='text-danger'>Unable to fetch news.</p>";
        console.error("Error fetching news:", error);
      }
    }
    
    async function fetchRSS(url) {
      try {
        const rss2jsonAPI = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
        const response = await fetch(rss2jsonAPI);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (data.status !== 'ok') {
          throw new Error('Failed to fetch RSS feed');
        }
        return data.items.slice(0, 5).map(item => ({
          title: item.title || "",
          link: item.link || "#",
          pubDate: item.pubDate || ""
        }));
      } catch (error) {
        console.error('Error fetching RSS:', error);
        return [];
      }
    }
    
    function populateSchedules() {
      // Populate individual series tabs
      populateTable("f1-table-body", scheduleData.f1Events, ["date", "race", "circuit", "time"]);
      populateTable("indy-table-body", scheduleData.indyEvents, ["date", "race", "venue", "network"]);
      populateTable("nascar-regular-table-body", scheduleData.nascarRegularEvents, ["date", "race", "venue", "network"]);
      populateTable("nascar-playoffs-table-body", scheduleData.nascarPlayoffEvents, ["date", "race", "venue", "network"]);
      
      // Populate All tab with combined and sorted events
      const allEvents = enhanceEventData();
      allEvents.sort((a, b) => a.start - b.start);
      
      const tbody = document.getElementById("all-table-body");
      const now = new Date();
      
      allEvents.forEach(event => {
        const tr = document.createElement("tr");
        const eventStartDate = event.start;
        tr.setAttribute("data-start", eventStartDate.toISOString());
        
        // Check if the race is completed
        if (eventStartDate < now) {
          tr.classList.add("completed-race");
        }
        
        // Create series badge
        const seriesBadge = document.createElement("div");
        seriesBadge.className = "series-badge";
        // Set the appropriate series name for NASCAR events
        let seriesName = event.series;
        if (event.series.includes("NASCAR")) {
          seriesName = event.series.includes("Playoffs") ? 
            "NASCAR Cup (Playoffs)" : "NASCAR Cup (Regular)";
        }
        seriesBadge.setAttribute("data-series", seriesName);
        seriesBadge.textContent = seriesName;
        
        // Create table cells
        const cells = [
          { content: event.date },
          { content: seriesBadge, isHTML: true },
          { content: event.race },
          { content: event.circuit || event.venue },
          { content: event.time ? convertToLocalTime(event.date, event.time) : event.network }
        ];
        
        cells.forEach(cell => {
          const td = document.createElement("td");
          if (cell.isHTML) {
            td.appendChild(cell.content);
          } else {
            td.textContent = cell.content;
          }
          tr.appendChild(td);
        });
        
        // Add podium results if race is completed
        if (eventStartDate < now) {
          let results = [];
          if (event.series === "Formula 1") {
            const raceName = event.race.replace(" GP", "");
            const result = resultsData.f1Past.results.find(r => 
              r.grandPrix.toLowerCase().includes(raceName.toLowerCase()) ||
              raceName.toLowerCase().includes(r.grandPrix.toLowerCase())
            );
            if (result) results.push(result);
          } else if (event.series === "IndyCar") {
            const result = resultsData.indyPast.results.find(r => 
              r.race.toLowerCase().includes(event.race.toLowerCase()) ||
              event.race.toLowerCase().includes(r.race.toLowerCase())
            );
            if (result) results.push(result);
          } else if (event.series.includes("NASCAR")) {
            if (event.race.includes("Duel")) {
              results = resultsData.nascarPast.results.filter(r => 
                r.race.toLowerCase().includes("duel")
              );
            } else {
              const eventShortName = event.race.split(" at ")[0].toLowerCase();
              const result = resultsData.nascarPast.results.find(r => 
                r.race.toLowerCase().includes(eventShortName) ||
                eventShortName.includes(r.race.toLowerCase())
              );
              if (result) results.push(result);
            }
          }
          
          if (results.length > 0) {
            const raceCell = tr.children[2]; // Race name cell
            const podiumDiv = document.createElement("div");
            podiumDiv.className = "podium-results";
            
            const podiumHTML = results.map(result => {
              let resultTitle = results.length > 1 ? `<strong>${result.race}:</strong><br>` : "";
              return `
                ${resultTitle}
                <span><span class="podium-position">1st:</span> ${result.winner}</span>
                <span><span class="podium-position">2nd:</span> ${result.second}</span>
                <span><span class="podium-position">3rd:</span> ${result.third}</span>
              `;
            }).join('<hr class="podium-divider">');
            
            podiumDiv.innerHTML = podiumHTML;
            raceCell.appendChild(podiumDiv);
          }
        }
        
        tr.addEventListener("click", () => openEventModal(event));
        tbody.appendChild(tr);
      });
    }
    
    // Update search functionality to be more modern
    function setupSearch() {
      const searchInput = document.getElementById("searchInput");
      const searchContainer = searchInput.parentElement;
      searchContainer.className = "search-container";
      
      // Add search icon
      const searchIcon = document.createElement("i");
      searchIcon.className = "search-icon fas fa-search";
      searchContainer.insertBefore(searchIcon, searchInput);
      
      // Add debounced search
      let searchTimeout;
      searchInput.addEventListener("input", function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const searchTerm = e.target.value.toLowerCase();
          const activeTab = document.querySelector(".tab-pane.active");
          
          activeTab.querySelectorAll("tbody tr").forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = "";
              // Highlight matching text
              row.querySelectorAll("td").forEach(cell => {
                const originalText = cell.textContent;
                if (originalText.toLowerCase().includes(searchTerm)) {
                  cell.innerHTML = originalText.replace(
                    new RegExp(searchTerm, "gi"),
                    match => `<mark>${match}</mark>`
                  );
                }
              });
            } else {
              row.style.display = "none";
            }
          });
        }, 200);
      });
    }
    
    function setupThemeToggle() {
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      
      function updateToggleIcon() {
        if (document.body.classList.contains("dark-mode")) {
          themeIcon.textContent = "☀️"; // Sun icon in dark mode
        } else {
          themeIcon.textContent = "🌙"; // Moon icon in light mode
        }
      }
      
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-mode");
      }
      updateToggleIcon();
      
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        updateToggleIcon();
      });
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      setupThemeToggle();
      setupSearch();
      populateSchedules();
      displayUpcomingEvent();
      fetchNews();
    });
  </script>
</body>
</html>